@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@using SFA.DAS.TeachInFurtherEducation.Contentful.Model.Interim
@using SFA.DAS.TeachInFurtherEducation.Web.Infrastructure
@using SFA.DAS.TeachInFurtherEducation.Web.Services
@inject DropdownMenuService DropdownMenuService


@addTagHelper *, NetEscapades.AspNetCore.SecurityHeaders.TagHelpers

@model (IEnumerable<MenuItem>?, bool?)
@{
    var homeMenu = Model.Item1!.FirstOrDefault(x=> !x.TopLevelMenuItem 
                                               && x.MenuItemText.Equals(RouteNames.Home, StringComparison.CurrentCultureIgnoreCase));
    var homeLink = homeMenu?.MenuItemSource;
}
<nav aria-label="top-menu" class="dfe-topnav fe-dfe-topnav" name="Other services navigation">
    <div class="govuk-width-container">
        <div class="flex-nav govuk-!-padding-top-5">
            &nbsp;
            <ul class="flex-right">
                <li>
                    <a href="#signUpForm" title="" class="govuk-link">Sign up for emails</a>
                </li>
                <li>
                    <svg aria-modal="true" aria-hidden="true" viewBox="0 -256 1850 1850" id="svg2989" height="30px" preserveAspectRatio="xMidYMid meet">
                        <g transform="matrix(1,0,0,-1,37.966102,1282.678)" id="g2991">
                            <path color="#ffffff" d="m 1664,32 v 768 q -32,-36 -69,-66 -268,-206 -426,-338 -51,-43 -83,-67 -32,-24 -86.5,-48.5 Q 945,256 897,256 h -1 -1 Q 847,256 792.5,280.5 738,305 706,329 674,353 623,396 465,528 197,734 160,764 128,800 V 32 Q 128,19 137.5,9.5 147,0 160,0 h 1472 q 13,0 22.5,9.5 9.5,9.5 9.5,22.5 z m 0,1051 v 11 13.5 q 0,0 -0.5,13 -0.5,13 -3,12.5 -2.5,-0.5 -5.5,9 -3,9.5 -9,7.5 -6,-2 -14,2.5 H 160 q -13,0 -22.5,-9.5 Q 128,1133 128,1120 128,952 275,836 468,684 676,519 682,514 711,489.5 740,465 757,452 774,439 801.5,420.5 829,402 852,393 q 23,-9 43,-9 h 1 1 q 20,0 43,9 23,9 50.5,27.5 27.5,18.5 44.5,31.5 17,13 46,37.5 29,24.5 35,29.5 208,165 401,317 54,43 100.5,115.5 46.5,72.5 46.5,131.5 z m 128,37 V 32 q 0,-66 -47,-113 -47,-47 -113,-47 H 160 Q 94,-128 47,-81 0,-34 0,32 v 1088 q 0,66 47,113 47,47 113,47 h 1472 q 66,0 113,-47 47,-47 47,-113 z" id="path2993" inkscape:connector-curvature="0" fill="#ffffff"></path>
                        </g>
                    </svg>
                </li>
            </ul>
        </div>
    </div>
</nav>

<header class="dfe-header" role="banner">
    <div class="dfe-width-container dfe-header__container">
        <div class="dfe-header__logo">
            <a class="dfe-header__link" href="@homeLink" aria-label="DfE homepage">
                <image src="/images/DesignSystem/dfe-logo.png" class="dfe-logo" alt=""/>
                <image src="/images/DesignSystem/dfe-logo-alt.png" class="dfe-logo-hover" alt=""/>
            </a>
        </div>
        <div class="dfe-header__content" id="content-header">
            <div class="dfe-header__menu">
                <button class="dfe-header__menu-toggle" id="toggle-menu" aria-controls="header-navigation" aria-expanded="false">Menu</button>
            </div>
            <div class="dfe-header__search">
                <image src="/images/DesignSystem/FurtherEducation.png" class="fe-logo" alt="share your skills"/>
            </div>
        </div>
    </div>
    

        <nav class="navbar" id="header-navigation" aria-label="Primary navigation">
            <div class="navbar__container">
                <p class="navbar__title">
                    <span id="label-navigation">Menu</span>
                    <button class="navbar__close" id="close-menu">
                        <svg class="dfe-icon dfe-icon__close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false" width="27" height="27">
                            <path d="M13.41 12l5.3-5.29a1 1 0 1 0-1.42-1.42L12 10.59l-5.29-5.3a1 1 0 0 0-1.42 1.42l5.3 5.29-5.3 5.29a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l5.29-5.3 5.29 5.3a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.42z"></path>
                        </svg>
                        <span class="govuk-visually-hidden">Close menu</span>
                    </button>
                </p>

                <div id="navbarNavDropdown">
                    <ul class="navbar__nav">
                        @{
                            var dropdownMenuItems = DropdownMenuService.GetDropdownMenuItems();
                            var currentPath = Context.Request.Path.ToString();

                            // Recursive function to check if any child (at any depth) is active
                            bool IsAnyChildActive(DropdownMenuItem menuItem)
                            {
                                if (currentPath.Equals(menuItem.Url, StringComparison.OrdinalIgnoreCase))
                                    return true;

                                if (menuItem.HasChildren)
                                {
                                    foreach (var child in menuItem.Children)
                                    {
                                        if (IsAnyChildActive(child))
                                            return true;
                                    }
                                }

                                return false;
                            }

                            // Recursive function to render menu items at any depth
                            void RenderMenuItem(DropdownMenuItem menuItem, int level)
                            {
                                var isActive = currentPath.Equals(menuItem.Url, StringComparison.OrdinalIgnoreCase);
                                var hasChildren = menuItem.HasChildren;
                                var isParentActive = hasChildren && IsAnyChildActive(menuItem);

                                if (level == 0)
                                {
                                    // Top level menu items
                                    <li class="navbar__nav-item navbar__nav-item-dropdown @(isParentActive ? "navbar__nav-item--active" : "")">
                                        @if (hasChildren)
                                        {
                                            <a class="navbar__link navbar__link--has-children @(isActive || isParentActive ? "navbar__link--active" : "")"
                                               href="@menuItem.Url"
                                               id="dropdown@(menuItem.Title?.Replace(" ", ""))"
                                               role="button"
                                               data-bs-toggle="dropdown"
                                               aria-expanded="false"
                                               onkeydown="handleDropdownKeydown(event, 'dropdown@(menuItem.Title?.Replace(" ", ""))')">
                                                @menuItem.Title
                                            </a>
                                            <ul class="navbar__dropdown" aria-labelledby="dropdown@(menuItem.Title?.Replace(" ", ""))">
                                                @foreach (var child in menuItem.Children)
                                                {
                                                    RenderMenuItem(child, level + 1);
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <a class="navbar__link @(isActive ? "navbar__link--active" : "")"
                                               href="@menuItem.Url">@menuItem.Title</a>
                                        }
                                    </li>
                                }
                                else if (level == 1)
                                {
                                    // Second level dropdown items
                                    if (hasChildren)
                                    {
                                        <li class="navbar__dropdown-item navbar__dropdown-item--has-children">
                                            <a class="navbar__dropdown-link @(isActive || isParentActive ? "navbar__dropdown-link--active" : "")"
                                               href="@menuItem.Url">
                                                @menuItem.Title
                                            </a>
                                            <ul class="navbar__dropdown-submenu">
                                                @foreach (var child in menuItem.Children)
                                                {
                                                    RenderMenuItem(child, level + 1);
                                                }
                                            </ul>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="navbar__dropdown-item">
                                            <a class="navbar__dropdown-link @(isActive ? "navbar__dropdown-link--active" : "")"
                                               href="@menuItem.Url">@menuItem.Title</a>
                                        </li>
                                    }
                                }
                                else
                                {
                                    // Third level and beyond - all use submenu structure
                                    if (hasChildren)
                                    {
                                        <li class="navbar__dropdown-submenu-item navbar__dropdown-submenu-item--has-children">
                                            <a class="navbar__dropdown-submenu-link @(isActive || isParentActive ? "navbar__dropdown-submenu-link--active" : "")"
                                               href="@menuItem.Url">
                                                @menuItem.Title
                                            </a>
                                            <ul class="navbar__dropdown-submenu">
                                                @foreach (var child in menuItem.Children)
                                                {
                                                    RenderMenuItem(child, level + 1);
                                                }
                                            </ul>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="navbar__dropdown-submenu-item">
                                            <a class="navbar__dropdown-submenu-link @(isActive ? "navbar__dropdown-submenu-link--active" : "")"
                                               href="@menuItem.Url">@menuItem.Title</a>
                                        </li>
                                    }
                                }
                            }
                        }
                        @foreach (var dropdownMenuItem in dropdownMenuItems)
                        {
                            RenderMenuItem(dropdownMenuItem, 0);
                        }
                    </ul>
                </div>
            </div>
        </nav>
    
</header>

